/*!
jquery.quiddle
(c) 2013 Benedikt Lang <github at benediktlang.de>
License: MIT
Build: 2013-11-13
*/
!function(a){"use strict";function b(b){return a(b).parentsUntil("body").andSelf().map(function(){return this.nodeName+":eq("+a(this).index()+")"}).get().join(">")}function c(b,c,d){var e=b.find(c);a.each(e,function(b,c){a(c).click(d)})}function d(c,d){var e=c.find(d),f=[];return a.each(e,function(c,d){var e=a(d),g=e.data("quiddle-type"),h=e.data("quiddle-file"),i=e.data("quiddle-marker");if("undefined"==typeof g||"undefned"==typeof i)throw new Error("Input metadata not correctly set (type,marker) for element: "+b(d));f.push({marker:i,file:h,type:g,elem:d})}),f}function e(a,b){var c=a.find(b);if(0===c.length)throw new Error('No preview element found by selector "'+b+'"');if(c.length>1)throw new Error('Multiple preview elements found by selector "'+b+'"');return c[0]}function f(b,c){a.each(b,function(a,b){var d=ace.edit(b.elem);b.editor=d,d.setTheme(c.theme),d.getSession().setMode("ace/mode/"+b.type),d.setHighlightActiveLine(!0),d.getSession().setUseWorker(!1),c.initMethod(d,b)})}function g(b,c){var d=a.ajax({url:b,dataType:"html",cache:!1});d.done(c),d.fail(function(){throw new Error("Can't find local file: "+b)})}var h="quiddle",i=function(b,c){this.elem=b,this.$elem=a(b),this.options=c,this.metadata=this.$elem.data("quiddle-options")};i.prototype={defaults:{template:null,emptyfile:"empty.html",inputSelector:".quiddle-input",previewSelector:".quiddle-preview",runBtnSelector:".quiddle-run",resetBtnSelector:".quiddle-reset",aceconfig:{theme:"ace/theme/monokai",initMethod:function(){}}},init:function(){var b=this;return this.config=a.extend(!0,{},this.defaults,this.options,this.metadata),this.template="",g(this.config.template,function(a){b.template=a}),this.inputs=d(this.$elem,this.config.inputSelector),this.elemPreview=e(this.$elem,this.config.previewSelector),f(this.inputs,this.config.aceconfig),this.fillInputs(),c(this.$elem,this.config.runBtnSelector,function(){b.renderPreview()}),c(this.$elem,this.config.resetBtnSelector,function(){b.fillInputs(),b.resetIFrame()}),this},fillInputs:function(){a.each(this.inputs,function(a,b){b.file?g(b.file,function(a){b.editor.getSession().setValue(a)}):b.editor.getSession().setValue("")})},resetIFrame:function(b){var c=this;a(this.elemPreview).on("load",function(){a(this).off("load"),"undefined"!=typeof b&&b.apply(c)}),a(this.elemPreview).attr("src",this.config.emptyfile)},renderPreview:function(){var b=this.template;if(0===b.length)throw new Error("Template not loaded yet");a.each(this.inputs,function(a,c){b=b.replace("%%%"+c.marker.toUpperCase()+"%%%",c.editor.getSession().getValue())}),this.resetIFrame(function(){var a=this.elemPreview,c=a.contentDocument||a.contentWindow.document;c.write(""),c.write(b),c.close()})}},i.defaults=i.prototype.defaults,a.fn[h]=function(b){return this.each(function(){a.data(this,"plugin_"+h)||a.data(this,"plugin_"+h,new i(this,b).init())})}}(jQuery,window,document);